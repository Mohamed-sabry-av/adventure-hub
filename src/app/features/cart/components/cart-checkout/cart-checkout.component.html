<div class="lg:ml-24 xl:ml-36 p-8 text-[#4d4f3a] lg:max-w-[550px] flex flex-col gap-y-5 border sticky-summary">
  <h2 class="font-semibold text-xl">Order summary</h2>
  <hr />

  <p>Tax included, shipping and discounts calculated at checkout.</p>

  <!-- Coupon code section -->
  <div class="flex flex-col gap-y-2">
    <div class="flex justify-between items-center">
      <p class="text-base font-semibold">Discount code:</p>
      <button *ngIf="!isCouponVisible" (click)="toggleCoupon()"
        class="text-sm text-orange-600 underline cursor-pointer">
        Add coupon
      </button>
    </div>

    @if (isCouponVisible) {
    <div class="flex gap-x-2">
      <input type="text" [value]="couponCode" (input)="couponCode = $any($event.target).value"
        class="border rounded p-2 flex-grow text-sm" placeholder="Enter discount code" />
      <button (click)="applyCoupon()" [disabled]="isApplyingCoupon"
        class="bg-[#3bb54a] hover:bg-[#2a9e39] disabled:bg-gray-400 text-white p-2 rounded text-sm">
        @if (isApplyingCoupon) {
        <i class="pi pi-spin pi-spinner"></i>
        } @else {
        Apply
        }
      </button>
    </div>
    }

    <!-- Applied coupon info -->
    @if (appliedCoupon) {
    <div class="flex justify-between items-center bg-green-50 p-2 rounded">
      <div class="flex items-center">
        <i class="pi pi-check-circle text-green-500 mr-2"></i>
        <span class="text-sm">{{ appliedCoupon.code }} applied</span>
      </div>
      <button (click)="removeCoupon()" class="text-sm text-red-500">
        <i class="pi pi-times"></i>
      </button>
    </div>
    }

    <!-- Coupon error message -->
    @if (couponError) {
    <div class="bg-red-50 text-red-500 p-2 rounded text-sm">
      {{ couponError }}
    </div>
    }
  </div>

  <!-- Shipping calculation section -->
  <div class="flex justify-between flex-col font-semibold">
    <p class="text-base">Shipping:</p>
    @if (!(loadedCart$ | async)?.cartIsLoaded) {
    <div class="bg-gray-200 p-4 h-[60px] flex items-center justify-center">
      <i class="pi pi-spin pi-spinner text-gray-500"></i>
    </div>
    } @else if (shippingError) {
    <div class="bg-red-50 p-4 text-center mt-2 text-sm rounded-lg text-red-600">
      <p>{{ shippingError }}</p>
      <button (click)="retryLoadingAddress()" class="text-blue-600 underline mt-2 text-xs">
        Try again
      </button>
      <p class="text-xs mt-2">
        We'll use default shipping options for now, but you can update your address during checkout.
      </p>
    </div>
    } @else if (isInternationalShipping) {
    <div class="bg-yellow-50 p-4 text-center mt-2 text-sm rounded-lg border border-yellow-200">
      <p>International shipping available. Our team will contact you to arrange delivery.</p>
      <button (click)="requestShippingQuote()" class="text-orange-600 underline mt-1">
        Request shipping quote
      </button>
      <p class="text-xs mt-2">
        Shipping from: {{ userAddress?.country || 'Unknown' }}
      </p>
    </div>
    } @else {
    <div class="bg-gray-200 p-4 text-center mt-2 text-sm rounded-lg">
      @if (isFreeShipping) {
      <p class="text-green-600 font-semibold">Free shipping available for your order!</p>
      } @else {
      <p>Shipping cost: <span class="font-bold" [innerHTML]="20 | currencySvg"></span></p>
      <p class="text-xs text-gray-600 mt-1">Spend <span [innerHTML]="(100 - cartTotal) | currencySvg"></span> more to
        qualify for free shipping</p>
      }
      @if (userAddress?.address) {
      <p class="text-xs mt-2">Shipping to: {{ userAddress?.address }}, {{ userAddress?.city }}, {{ userAddress?.country
        }}</p>
      }
    </div>
    }
  </div>

  @if (!(loadedCart$ | async)?.cartIsLoaded) {
  <!-- Loading state for total -->
  <div class="flex justify-between font-semibold">
    <p class="text-lg">Total:</p>
    <div class="w-24 h-6 bg-gray-200 animate-pulse rounded"></div>
  </div>
  } @else {
  <!-- Subtotal -->
  <div class="flex justify-between">
    <p class="text-base">Subtotal:</p>
    <p [innerHTML]="(loadedCart$ | async)?.userCart?.totals?.sub_total | currencySvg"></p>
  </div>

  <!-- Shipping fee if applicable -->
  @if (!isInternationalShipping) {
  <div class="flex justify-between">
    <p class="text-base">Shipping:</p>
    <p [innerHTML]="isFreeShipping ? 'Free' : (20 | currencySvg)"></p>
  </div>
  }

  <!-- Total -->
  <div class="flex justify-between font-semibold">
    <p class="text-lg">Total:</p>
    <p class="text-black">
      @if (isInternationalShipping) {
      Contact us for shipping quote
      } @else {
      <span [innerHTML]="calculateTotal() | currencySvg"></span>
      }
    </p>
  </div>
  }

  <div>
    <a routerLink="/checkout">
      <button
        class="bg-[#3BB45A] hover:bg-[#2a9e39] transition-colors duration-300 font-semibold text-white p-3 rounded-md w-full">
        <i class="pi pi-shopping-bag mr-2 "></i>
        <span>Checkout</span>
      </button>
    </a>

    <!-- Wallet payment buttons -->
    @if ((loadedCart$ | async)?.cartIsLoaded && ((loadedCart$ | async)?.userCart?.items?.length > 0)) {
    @if (showWalletPayment) {
    <div class="mt-4">
      <div class="mb-2 text-sm text-center">or pay with</div>
      <app-wallet-payment (paymentSucceeded)="onPaymentSuccess($event)" [shippingOptions]="getShippingOptions()">
      </app-wallet-payment>
    </div>
    }
    }

    <a [routerLink]="['']" class="cursor-pointer block mt-4 text-center text-orange-600 text-sm underline">Continue
      Shopping</a>
  </div>
</div>