<main class="product-page-container">


  <app-container>
    @if (isLoading) {
    <!-- Skeleton loading state for product details -->
    <div class="animate-pulse py-4 px-3">
      <div class="max-w-screen-xl mx-auto">
        <div class="flex flex-col md:flex-row gap-8">
          <!-- Skeleton for product image -->
          <div class="md:w-1/2 lg:w-3/5 mobile-order-1">
            <div class="aspect-square bg-gray-200 rounded-lg mb-4"></div>
          </div>

          <!-- Skeleton for product info -->
          <div class="md:w-1/2 lg:w-2/5 mobile-order-2">
            <div class="h-8 bg-gray-200 rounded mb-4 w-3/4"></div>
            <div class="h-6 bg-gray-200 rounded mb-4 w-1/2"></div>
            <div class="h-4 bg-gray-200 rounded mb-8 w-1/4"></div>

            <div class="h-5 bg-gray-200 rounded mb-2 w-1/3"></div>
            <div class="flex gap-3 mb-6">
              @for (i of [0, 1, 2, 3]; track i) {
              <div class="h-10 w-10 bg-gray-200 rounded-sm"></div>
              }
            </div>

            <div class="h-5 bg-gray-200 rounded mb-2 w-1/3"></div>
            <div class="flex gap-3 mb-6">
              @for (i of [0, 1, 2, 3]; track i) {
              <div class="h-8 w-12 bg-gray-200 rounded-sm"></div>
              }
            </div>

            <div class="grid grid-cols-2 gap-4 mt-8">
              <div class="h-12 bg-gray-200 rounded"></div>
              <div class="h-12 bg-gray-200 rounded"></div>
            </div>
          </div>
        </div>

        <!-- Skeleton for description -->
        <div class="space-y-4 mt-8 mobile-order-3">
          <div class="h-6 bg-gray-200 rounded w-1/4"></div>
          <div class="h-4 bg-gray-200 rounded w-full"></div>
          <div class="h-4 bg-gray-200 rounded w-3/4"></div>
          <div class="h-4 bg-gray-200 rounded w-full"></div>
        </div>
      </div>
    </div>
    } @else if (productData) {
    <!-- Breadcrumb for navigation (loads early) -->
    <app-breadcrumb [paths]="productData.categories || []" [productName]="productData.name">
    </app-breadcrumb>

    <!-- Product Navigation -->
    @if (previousProduct || nextProduct) {
    <div class="product-navigation flex justify-between items-center my-4">
      @if (previousProduct) {
      <button (click)="navigateToProduct(previousProduct.slug)"
        class="flex items-center text-gray-700 hover:text-primary-600 transition-colors">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24"
          stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
        <span class="hidden sm:inline">Previous:</span>
        <span class="ml-1 font-medium truncate max-w-[150px] inline-block" [innerHTML]="previousProduct.title"></span>
      </button>
      } @else {
      <div></div> <!-- Empty div for spacing -->
      }


      @if (nextProduct) {
      <button (click)="navigateToProduct(nextProduct.slug)"
        class="flex items-center text-gray-700 hover:text-primary-600 transition-colors">
        <span class="hidden sm:inline">Next:</span>
        <span class="mx-1 font-medium truncate max-w-[150px] inline-block" [innerHTML]="nextProduct.title"></span>
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-1" fill="none" viewBox="0 0 24 24"
          stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg>
      </button>
      } @else {
      <div></div> <!-- Empty div for spacing -->
      }
    </div>
    }

    <div class="mobile-flex-container">
      <div class="flex flex-col md:flex-row gap-8 mb-8">
        <!-- Left side: Images -->
        <div class="md:w-1/2 lg:w-3/5 mobile-order-1">
          <!-- Product Images - Critical for viewing -->
          <app-product-images [productImages]="productData.images" [selectedColor]="selectedColor"
            [selectedVariation]="selectedVariation">
          </app-product-images>

          <!-- Desktop Description - Only visible on desktop -->
          <div class="desktop-description">
            @defer (on viewport) {
            <app-product-desc [product]="productDataForDesc"></app-product-desc>
            } @placeholder (minimum 200ms) {
            <div class="animate-pulse mt-8">
              <div class="h-7 bg-gray-200 rounded mb-4 w-1/4"></div>
              <div class="h-4 bg-gray-200 rounded mb-2 w-full"></div>
              <div class="h-4 bg-gray-200 rounded mb-2 w-full"></div>
              <div class="h-4 bg-gray-200 rounded mb-2 w-3/4"></div>
            </div>
            }
          </div>
        </div>

        <!-- Product Info - Critical for purchase decisions (Right side, sticky) -->
        <div class="md:w-1/2 lg:w-2/5 sticky-wrapper mobile-order-2">
          <div class="sticky-info">
            <app-product-info [productInfo]="productData" (selectedAttributeChange)="onSelectedColorChange($event)"
              (variationSelected)="onVariationSelected($event)">
            </app-product-info>
          </div>
        </div>
      </div>

      <!-- Mobile Description - Only visible on mobile -->
      <div class="mobile-description mobile-order-3 mt-6 mb-8">
        @defer (on viewport) {
        <app-product-desc [product]="productDataForDesc"></app-product-desc>
        } @placeholder (minimum 200ms) {
        <div class="animate-pulse">
          <div class="h-7 bg-gray-200 rounded mb-4 w-1/4"></div>
          <div class="h-4 bg-gray-200 rounded mb-2 w-full"></div>
          <div class="h-4 bg-gray-200 rounded mb-2 w-full"></div>
          <div class="h-4 bg-gray-200 rounded mb-2 w-3/4"></div>
        </div>
        }
      </div>
    </div>

    <!-- Related Products - Lowest priority, load last -->
    @defer (on viewport; on idle) {
    <app-product-related [productId]="productData.id"
      [relatedIds]="productData.related_ids || []"></app-product-related>
    } @placeholder (minimum 200ms) {
    <div class="mt-12">
      <h2 class="text-xl font-semibold mb-6">You May Also Like</h2>
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
        @for (i of [0, 1, 2, 3]; track i) {
        <div class="animate-pulse">
          <div class="bg-gray-200 h-40 rounded-lg mb-2"></div>
          <div class="h-4 bg-gray-200 rounded mb-2"></div>
          <div class="h-4 bg-gray-200 rounded w-1/2"></div>
        </div>
        }
      </div>
    </div>
    }

    <!-- Recently Viewed Products - Only load on idle -->
    @defer (on viewport; on idle) {
    <app-recent-products-mini></app-recent-products-mini>
    } @placeholder {
    <div class="mt-12">
      <h2 class="text-xl font-semibold mb-6">Recently Viewed Products</h2>
      <div class="animate-pulse grid grid-cols-2 md:grid-cols-4 gap-4">
        @for (i of [0, 1, 2, 3]; track i) {
        <div>
          <div class="bg-gray-200 h-40 rounded-lg mb-2"></div>
          <div class="h-4 bg-gray-200 rounded mb-2"></div>
          <div class="h-4 bg-gray-200 rounded w-1/2"></div>
        </div>
        }
      </div>
    </div>
    }

    }
  </app-container>

  <app-dialog-error></app-dialog-error>
</main>