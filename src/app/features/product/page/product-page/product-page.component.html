<main class="product-page-container">


  <app-container>
    @if (isLoading) {
    <!-- Skeleton loading state for product details -->
    <div class="animate-pulse py-4 px-3" aria-label="Loading product information">
      <div class="max-w-screen-xl mx-auto">
        <div class="flex flex-col md:flex-row gap-8">
          <!-- Skeleton for product image -->
          <div class="md:w-1/2 lg:w-3/5 mobile-order-1">
            <div class="aspect-square bg-gray-200 rounded-lg mb-4" aria-hidden="true"></div>
          </div>

          <!-- Skeleton for product info -->
          <div class="md:w-1/2 lg:w-2/5 mobile-order-2">
            <div class="h-8 bg-gray-200 rounded mb-4 w-3/4" aria-hidden="true"></div>
            <div class="h-6 bg-gray-200 rounded mb-4 w-1/2" aria-hidden="true"></div>
            <div class="h-4 bg-gray-200 rounded mb-8 w-1/4" aria-hidden="true"></div>

            <div class="h-5 bg-gray-200 rounded mb-2 w-1/3" aria-hidden="true"></div>
            <div class="flex gap-3 mb-6">
              @for (i of [0, 1, 2, 3]; track i) {
              <div class="h-10 w-10 bg-gray-200 rounded-sm" aria-hidden="true"></div>
              }
            </div>

            <div class="h-5 bg-gray-200 rounded mb-2 w-1/3" aria-hidden="true"></div>
            <div class="flex gap-3 mb-6">
              @for (i of [0, 1, 2, 3]; track i) {
              <div class="h-8 w-12 bg-gray-200 rounded-sm" aria-hidden="true"></div>
              }
            </div>

            <div class="grid grid-cols-2 gap-4 mt-8">
              <div class="h-12 bg-gray-200 rounded" aria-hidden="true"></div>
              <div class="h-12 bg-gray-200 rounded" aria-hidden="true"></div>
            </div>
          </div>
        </div>

        <!-- Skeleton for description -->
        <div class="space-y-4 mt-8 mobile-order-3">
          <div class="h-6 bg-gray-200 rounded w-1/4" aria-hidden="true"></div>
          <div class="h-4 bg-gray-200 rounded w-full" aria-hidden="true"></div>
          <div class="h-4 bg-gray-200 rounded w-3/4" aria-hidden="true"></div>
          <div class="h-4 bg-gray-200 rounded w-full" aria-hidden="true"></div>
        </div>
      </div>
    </div>
    } @else if (productData) {
    <!-- Breadcrumb for navigation (loads early) -->
    <nav aria-label="Breadcrumb navigation">
      <app-breadcrumb [paths]="productData.categories || []" [productName]="productData.name">
      </app-breadcrumb>
    </nav>

    <!-- Product Navigation -->
    @if (previousProduct || nextProduct) {
    <nav class="product-navigation flex justify-between items-center my-4" aria-label="Product navigation">
      @if (previousProduct) {
      <button (click)="navigateToProduct(previousProduct.slug)"
        class="flex items-center text-gray-700 hover:text-primary-600 transition-colors"
        aria-label="Go to previous product">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24"
          stroke="currentColor" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
        <span class="hidden sm:inline text-sm md:text-base">Previous:</span>
        <span class="ml-1 font-medium truncate max-w-[150px] inline-block text-xs sm:text-sm md:text-base"
          [innerHTML]="previousProduct.title"></span>
      </button>
      } @else {
      <div></div> <!-- Empty div for spacing -->
      }

      @if (nextProduct) {
      <button (click)="navigateToProduct(nextProduct.slug)"
        class="flex items-center text-gray-700 hover:text-primary-600 transition-colors"
        aria-label="Go to next product">
        <span class="hidden sm:inline text-sm md:text-base">Next:</span>
        <span class="mx-1 font-medium truncate max-w-[150px] inline-block text-xs sm:text-sm md:text-base"
          [innerHTML]="nextProduct.title"></span>
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-1" fill="none" viewBox="0 0 24 24"
          stroke="currentColor" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg>
      </button>
      } @else {
      <div></div> <!-- Empty div for spacing -->
      }
    </nav>
    }

    <article class="mobile-flex-container">
      <header>
        <h1 class="sr-only">{{productData.name}}</h1>
      </header>

      <div class="flex flex-col md:flex-row gap-8 mb-8">
        <!-- Left side: Images -->
        <div class="md:w-1/2 lg:w-3/5 mobile-order-1">
          <!-- Product Images -->
          <app-product-images [productImages]="productData.images" [selectedColor]="selectedColor"
            [selectedVariation]="selectedVariation">
          </app-product-images>

          <!-- Desktop Description -->
          <div class="desktop-description">
            <app-product-desc [product]="productData"></app-product-desc>
          </div>
        </div>

        <!-- Product Info -->
        <div class="md:w-1/2 lg:w-2/5 sticky-wrapper mobile-order-2">
          <div class="sticky-info">
            <app-product-info [productInfo]="productData" (selectedAttributeChange)="onSelectedColorChange($event)"
              (variationSelected)="onVariationSelected($event)">
            </app-product-info>
          </div>
        </div>
      </div>

      <!-- Mobile Description -->
      <div class="mobile-description mobile-order-3 mt-6 mb-8">
        <app-product-desc [product]="productData"></app-product-desc>
      </div>
    </article>

    <!-- Related Products - Lowest priority, load last -->
    @defer (on viewport; on idle) {
    <section aria-labelledby="related-products-heading">
      <app-product-related [productId]="productData.id"
        [relatedIds]="productData.related_ids || []"></app-product-related>
    </section>
    } @placeholder (minimum 200ms) {
    <div class="mt-12" aria-label="Loading related products">
      <h2 class="text-xl font-semibold mb-6">You May Also Like</h2>
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
        @for (i of [0, 1, 2, 3]; track i) {
        <div class="animate-pulse">
          <div class="bg-gray-200 h-40 rounded-lg mb-2" aria-hidden="true"></div>
          <div class="h-4 bg-gray-200 rounded mb-2" aria-hidden="true"></div>
          <div class="h-4 bg-gray-200 rounded w-1/2" aria-hidden="true"></div>
        </div>
        }
      </div>
    </div>
    }

    <!-- Recently Viewed Products - Only load on idle -->
    @defer (on viewport; on idle) {
    <section aria-labelledby="recently-viewed-heading">
      <app-recent-products-mini></app-recent-products-mini>
    </section>
    } @placeholder {
    <div class="mt-12" aria-label="Loading recently viewed products">
      <h2 class="text-xl font-semibold mb-6">Recently Viewed Products</h2>
      <div class="animate-pulse grid grid-cols-2 md:grid-cols-4 gap-4">
        @for (i of [0, 1, 2, 3]; track i) {
        <div>
          <div class="bg-gray-200 h-40 rounded-lg mb-2" aria-hidden="true"></div>
          <div class="h-4 bg-gray-200 rounded mb-2" aria-hidden="true"></div>
          <div class="h-4 bg-gray-200 rounded w-1/2" aria-hidden="true"></div>
        </div>
        }
      </div>
    </div>
    }

    }
  </app-container>
</main>