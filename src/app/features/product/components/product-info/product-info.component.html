<div class="product-info">
  <!-- Product Tags -->
  <div class="product-tags flex flex-wrap gap-2 mb-4" *ngIf="getProductTags().length > 0">
    <span *ngFor="let tag of getProductTags()" [ngClass]="getTagClass(tag)"
      class="inline-block px-2 py-1 text-xs font-medium rounded-md" [class.hub-tag-wrapper]="tag === 'HUB'">
      <ng-container *ngIf="tag !== 'HUB'; else hubTag">
        {{ tag }}
      </ng-container>
      <ng-template #hubTag>
        <img src="assets/Hub-logo/black-hub.png" alt="Hub" class="hub-icon-product">
      </ng-template>
    </span>
  </div>

  <h1 class="text-3xl font-medium text-olive mb-2 flex items-start justify-between">
    {{ productInfo()?.name }}
    <button
      class="share-button ml-2 flex items-center justify-center text-gray-600 hover:text-orange-500 transition-colors"
      (click)="shareProduct()" aria-label="Share product">
      <i class="pi pi-share-alt text-xl"></i>
    </button>
  </h1>

  <!-- Warranty Information -->
  <div class="warranty-info mb-4" *ngIf="getWarrantyInfo()">
    <i class="pi pi-shield"></i>
    <span class="font-medium">{{ getWarrantyInfo() }}</span>
  </div>

  <!-- Price -->
  <div class="flex items-baseline mb-4 gap-2">
    <span class="text-2xl font-bold" [appCurrencyPrice]="getNumericPrice(getPriceInfo().price)"></span>
    <ng-container *ngIf="getPriceInfo().isOnSale">
      <span class="text-gray-500 line-through text-lg ml-2"
        [appCurrencyPrice]="getNumericPrice(getPriceInfo().regularPrice)"></span>
    </ng-container>
  </div>

  <div class="product-brand" *ngIf="brandName !== 'brand'">
    <span class="brand-label"></span>
    <a [routerLink]="['/product/brand', brandSlug]" class="brand-link">{{ brandName }}</a>
  </div>

  <!-- Stock Status Message -->
  <div class="stock-status mt-2 mb-3">
    <ng-container *ngIf="isCompletelyOutOfStock">
      <span class="text-red-500 font-medium flex items-center">
        <i class="pi pi-times-circle mr-1"></i> Out of Stock
      </span>
    </ng-container>
    <ng-container
      *ngIf="!isCompletelyOutOfStock && isProductInStock && (allVariationAttributesSelected || productInfo()?.type === 'simple')">
      <ng-container *ngIf="maxLength <= 5 && maxLength > 0">
        <span class="text-red-500 font-medium flex items-center">
          <i class="pi pi-exclamation-circle mr-1"></i> Low Stock: Only {{ maxLength }} left
        </span>
      </ng-container>
      <ng-container *ngIf="maxLength > 5">
        <span class="text-green-600 font-medium flex items-center">
          <i class="pi pi-check-circle mr-1"></i> In Stock: {{ maxLength }} available
        </span>
      </ng-container>
    </ng-container>
  </div>

  <!-- Delivery Estimation -->
  <app-delivery-estimate [isHubProduct]="isHubProduct"></app-delivery-estimate>

  <!-- Variation Selection -->
  <div *ngIf="productInfo()?.type === 'variable' && !isCompletelyOutOfStock">
    <!-- Color Options -->
    <ng-container *ngIf="getVariationOptions('Color').length">
      <div class="product-option">
        <label class="option-label">Color: <span class="selected-attribute" *ngIf="selectedAttributes['Color']">{{
            selectedAttributes['Color'] }}</span></label>
        <div class="color-options">
          <div *ngFor="let option of getVariationOptions('Color'); let i = index" class="color-option"
            [class.active]="selectedAttributes['Color'] === option.value" [class.out-of-stock]="!option.inStock"
            (click)="option.inStock && handleAttributeClick($event, 'Color', option.value)">
            <div class="color-swatch" [style.background-image]="'url(' + option.image + ')'" [title]="option.value">
              <div class="out-of-stock-x" *ngIf="!option.inStock"></div>
            </div>
          </div>
        </div>
      </div>
    </ng-container>

    <!-- Size Options (Filtered by Selected Color, including out of stock) -->
    <ng-container *ngIf="getVariationOptions('Size', selectedAttributes['Color']).length">
      <div class="product-option">
        <label class="option-label">Size: <span class="selected-attribute" *ngIf="selectedAttributes['Size']">{{
            selectedAttributes['Size'] }}</span></label>
        <div class="size-options">
          <div *ngFor="let option of getVariationOptions('Size', selectedAttributes['Color']); let i = index"
            class="size-option" [class.active]="selectedAttributes['Size'] === option.value"
            [class.out-of-stock]="!option.inStock"
            (click)="option.inStock && handleAttributeClick($event, 'Size', option.value)">
            {{ option.value }}
            <div class="out-of-stock-x" *ngIf="!option.inStock"></div>
          </div>
        </div>
      </div>
    </ng-container>
  </div>

  <!-- Prompt to Select Variation -->
  <div *ngIf="
      !allVariationAttributesSelected &&
      !isCompletelyOutOfStock &&
      productInfo()?.type === 'variable'
    ">
    <span class="text-gray-500">Please select all options to check availability</span>
  </div>

  <!-- Quantity Controls, Add to Cart, Buy Now, and Wallet Payment Buttons -->
  <div *ngIf="(allVariationAttributesSelected || productInfo()?.type === 'simple') && isProductInStock">
    <!-- Quantity and Add to Cart in same row -->
    <div class="cart-action-row mt-6 mb-4" [class.hidden]="isFooterVisible$">
      <div class="quantity-selector">
        <button class="quantity-btn" (click)="onQuantityDown()" [disabled]="quantity <= 1"
          aria-label="Decrease quantity">
          âˆ’
        </button>
        <span class="quantity-display" aria-live="polite" aria-atomic="true">{{ quantity }}</span>
        <button class="quantity-btn" (click)="onQuantityUp()" [disabled]="quantity >= maxLength"
          aria-label="Increase quantity">
          +
        </button>
      </div>

      <button class="cart-btn" (click)="addToCart()" [disabled]="(loadingMap$ | async)?.['add']"
        aria-label="Add to cart">
        <ng-container *ngIf="(loadingMap$ | async)?.['add']; else addToCartText">
          <div class="spinner-container" role="status" aria-live="polite" aria-label="Adding to cart">
            <div class="spinner"></div>
          </div>
        </ng-container>
        <ng-template #addToCartText>ADD TO CART</ng-template>
      </button>

      <button class="wishlist-btn" (click)="addToWishList(productInfo()?.id)" [class.active]="isInWishlist"
        [disabled]="isAddingToWishlist" aria-label="Add to wishlist">
        <i class="pi pi-heart"></i>
      </button>
    </div>

    <!-- Buy Now button full width -->
    <div class="buy-now-container mb-4">
      <button class="buy-btn" (click)="buyNow()" [disabled]="(loadingMap$ | async)?.['buy']" aria-label="Buy Now">
        <ng-container *ngIf="(loadingMap$ | async)?.['buy']; else buyNowText">
          <div class="spinner-container" role="status" aria-live="polite" aria-label="Processing purchase">
            <div class="spinner"></div>
          </div>
        </ng-container>
        <ng-template #buyNowText>BUY NOW</ng-template>
      </button>
    </div>

    <!-- Wallet Payment Button -->
    <div class="wallet-payment-container mb-4" aria-label="Wallet payment option">
      <app-wallet-payment [product]="getCartProduct()"
        (paymentSucceeded)="onWalletPaymentSucceeded($event)"></app-wallet-payment>
    </div>

    <app-tabby-promo [price]="getPriceInfo().price" currency="AED" lang="en" source="product"
      [publicKey]="tabbyConfig.publicKey" [merchantCode]="tabbyConfig.merchantCode"
      [shouldInheritBg]="true"></app-tabby-promo>
  </div>

  <!-- Out of Stock for Selected Variation -->
  <div *ngIf="
      allVariationAttributesSelected &&
      !isProductInStock &&
      !isCompletelyOutOfStock
    ">
    <span class="text-red-500 font-medium flex items-center">
      <i class="pi pi-times-circle mr-1"></i> This variation is out of stock
    </span>
  </div>

  <!-- Wishlist message -->
  <div *ngIf="wishlistMessage" class="mt-2 text-sm" [class.text-green-500]="wishlistSuccess"
    [class.text-red-500]="!wishlistSuccess" role="alert" aria-live="assertive">
    {{ wishlistMessage }}
  </div>

  <div class="mt-6 flex flex-col gap-y-1" aria-label="Shipping and return information">
    <p class="text-sm">
      <span><i class="pi pi-check-circle text-sm mr-1"></i></span> Free Shipping
      in UAE For orders above AED 100.
    </p>
    <p class="text-sm">
      <span><i class="pi pi-check-circle text-sm mr-1"></i></span> 7 days easy
      returns.
    </p>
    <p class="text-sm">
      <span><i class="pi pi-check-circle text-sm mr-1"></i></span>
      <ng-container *ngIf="isHubProduct">
        Next day delivery in Dubai (order before 11 AM).
      </ng-container>
      <ng-container *ngIf="!isHubProduct">
        Delivery in 1-2 working days.
      </ng-container>
    </p>
    <p class="text-sm">
      <span><i class="pi pi-check-circle text-sm mr-1"></i></span> World wide
      shipping.
    </p>
  </div>
</div>

<div class="sticky-footer block md:hidden" [class.visible]="isFooterVisible$">
  <div class="quantity-controls">
    <button class="quantity-btn" (click)="onQuantityDown()" [disabled]="quantity <= 1">-</button>
    <span class="quantity-display">{{quantity}}</span>
    <button class="quantity-btn" (click)="onQuantityUp()" [disabled]="quantity >= maxLength">+</button>
  </div>
  <button class="add-to-cart-btn" (click)="addToCart()"
    [disabled]="!isProductInStock || !allVariationAttributesSelected">
    Add to Cart
  </button>
  <button class="share-btn" (click)="shareProduct()" aria-label="Share product">
    <i class="pi pi-share-alt"></i>
  </button>
</div>

<div class="sticky-add-to-cart" *ngIf="isFooterVisible$ | async">
  <div class="container">
    <div class="product-info">
      <div class="product-title">{{ productInfo().name }}</div>
      <div class="product-price">
        <span [class.sale-price]="getPriceInfo().isOnSale" [appCurrencyPrice]="getNumericPrice(getPriceInfo().price)">
        </span>
        <span class="regular-price" *ngIf="getPriceInfo().isOnSale"
          [appCurrencyPrice]="getNumericPrice(getPriceInfo().regularPrice)">
        </span>
      </div>
    </div>
    <div class="actions">
      <button class="cart-btn" (click)="addToCart()" [disabled]="(loadingMap$ | async)?.['add']"
        aria-label="Add to cart">
        <ng-container *ngIf="(loadingMap$ | async)?.['add']; else addToCartText">
          <div class="spinner-container" role="status" aria-live="polite" aria-label="Adding to cart">
            <div class="spinner"></div>
          </div>
        </ng-container>
        <ng-template #addToCartText>ADD TO CART</ng-template>
      </button>
    </div>
  </div>
</div>