<!-- Quick Add Container -->
<div class="add-button-container">
  <!-- Normal state button -->
  <button *ngIf="!addSuccess && !(isLoading && (loadingMap$ | async)?.['add'])" class="circular-add-button"
    [class.disabled]="(product?.type === 'variable' && !isReadyToAddToCart()) || 
                     (product?.type === 'simple' && product?.stock_status !== 'instock')"
    [class.ready-to-add]="isReadyToAddToCart() && optionsVisible"
    (click)="optionsVisible && isReadyToAddToCart() ? onAddToCart() : onToggleOptionsPanel()" [attr.aria-label]="product?.type === 'simple' ? 'Add to cart' : 
                      (hasOnlyColors() && selectedColor ? 'Add to cart' :
                      (optionsVisible && selectedVariation ? 'Add to cart' : 'Choose options'))" [title]="product?.type === 'simple' ? 'Add to cart' : 
            (hasOnlyColors() && selectedColor ? 'Add to cart' : 
            (optionsVisible && selectedVariation ? 'Add to cart' : 'Choose options'))">
    <svg *ngIf="!(product?.type === 'variable' && !isReadyToAddToCart()) && 
               !(product?.type === 'simple' && product?.stock_status !== 'instock')" class="plus-icon"
      viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
      stroke-linejoin="round">
      <line x1="12" y1="5" x2="12" y2="19"></line>
      <line x1="5" y1="12" x2="19" y2="12"></line>
    </svg>
    <span *ngIf="(product?.type === 'variable' && !isReadyToAddToCart() && !optionsVisible) || 
                (product?.type === 'simple' && product?.stock_status !== 'instock')" class="out-of-stock-text">Out of
      Stock</span>
  </button>

  <!-- Loading state -->
  <button *ngIf="isLoading && (loadingMap$ | async)?.['add']" class="circular-add-button loading" disabled>
    <div class="spinner"></div>
  </button>

  <!-- Success confirmation -->
  <button *ngIf="addSuccess" class="circular-add-button add-success" disabled>
    <svg class="check-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <polyline points="20 6 9 17 4 12"></polyline>
    </svg>
  </button>
</div>

<!-- Options panel that appears within the product card -->
<div *ngIf="optionsVisible && product?.type === 'variable'" #optionsPanel [@slideUpDown] class="options-panel"
  [class.options-panel-mobile]="isMobile">
  <!-- Panel header with product name and close button -->
  <div class="options-panel-header">
    <span class="product-name-truncate" [title]="product?.name">{{product?.name}}</span>
    <button class="close-options-btn" (click)="onToggleOptionsPanel()" aria-label="Close options">
      <svg viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" stroke-width="2" fill="none"
        stroke-linecap="round" stroke-linejoin="round">
        <line x1="18" y1="6" x2="6" y2="18"></line>
        <line x1="6" y1="6" x2="18" y2="18"></line>
      </svg>
    </button>
  </div>

  <!-- Color options if available -->
  <div *ngIf="colorOptions && colorOptions.length > 0" class="color-options-container">
    <h4 class="options-title">Color</h4>
    <div class="color-swatches">
      <div *ngFor="let color of colorOptions" class="color-swatch" [class.selected]="selectedColor === color.color"
        [class.out-of-stock]="!color.inStock" (click)="setColorAndSize(color.color)"
        [attr.title]="formatColorName(color.color)">
        <!-- Color swatch with image background -->
        <div class="swatch-inner" [style.background-color]="getColorValue(color.color)"
          [style.background-image]="color.image ? 'url(' + color.image + ')' : ''" [style.background-size]="'cover'"
          [style.background-position]="'center'" [style.background-repeat]="'no-repeat'">
        </div>
        <div *ngIf="selectedColor === color.color" class="color-check-mark">âœ“</div>
        <!-- Show color name on hover -->
        <div class="color-tooltip">{{formatColorName(color.color)}}</div>
      </div>
    </div>
  </div>

  <!-- Size options if available -->
  <div *ngIf="uniqueSizes && uniqueSizes.length > 0" class="size-options-container">
    <h4 class="options-title">Size</h4>
    <div class="size-options" #sizeOptionsContainer>
      <button *ngFor="let sizeObj of uniqueSizes" class="size-btn" [class.selected]="selectedSize === sizeObj.size"
        [class.out-of-stock]="!sizeObj.inStock" [disabled]="!sizeObj.inStock" (click)="selectSize.emit(sizeObj.size)"
        [title]="formatSizeName(sizeObj.size) + (sizeObj.inStock ? '' : ' (Out of Stock)')">
        {{ formatSizeName(sizeObj.size) }}
      </button>
    </div>

    <!-- Size scroll controls (only show if overflow) -->
    <div *ngIf="uniqueSizes && uniqueSizes.length > 4" class="size-scroll-controls">
      <button class="size-scroll-btn prev" (click)="scrollSizes(sizeOptionsContainer, -80)"
        aria-label="Scroll sizes left">
        <svg viewBox="0 0 24 24" width="12" height="12" stroke="currentColor" stroke-width="2" fill="none">
          <polyline points="15 18 9 12 15 6"></polyline>
        </svg>
      </button>
      <button class="size-scroll-btn next" (click)="scrollSizes(sizeOptionsContainer, 80)"
        aria-label="Scroll sizes right">
        <svg viewBox="0 0 24 24" width="12" height="12" stroke="currentColor" stroke-width="2" fill="none">
          <polyline points="9 18 15 12 9 6"></polyline>
        </svg>
      </button>
    </div>
  </div>

  <!-- Instructions text -->
  <!-- For products with only colors -->
  <div *ngIf="hasOnlyColors() && selectedColor" class="selection-ready">
    Click + button to add to cart
  </div>
  <div *ngIf="hasOnlyColors() && !selectedColor" class="selection-required">
    Please select a color
  </div>

  <!-- For products with both colors and sizes -->
  <div *ngIf="!hasOnlyColors() && isReadyToAddToCart()" class="selection-ready">
    Click + button to add to cart
  </div>
  <div *ngIf="!hasOnlyColors() && !isReadyToAddToCart()" class="selection-required">
    Please select all required options
  </div>
</div>

<!-- Optional Quick View Button - can be uncommented if needed -->
<!-- <div class="quick-view-button">
  <button
    class="quick-view-btn"
    (click)="onToggleOptionsPanel()">
    Quick View
  </button>
</div> -->